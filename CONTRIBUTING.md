# Contributing to OSRS Wiki Bucket Builder

Thanks for your interest in contributing! This guide will help you get set up and understand how the project is structured.

## Project Structure

```
osrs-wiki-bucket-builder/
├── src/
│   ├── index.ts                # Package entry point (re-exports)
│   ├── query-builder.ts        # The main BucketQueryBuilder class and bucket() factory
│   ├── types.ts                # Type definitions, Bucket helper object, BucketResponse
│   ├── generated/
│   │   └── definitions.ts      # Auto-generated bucket interfaces and field maps
│   └── tests/
│       └── query-builder.test.ts
├── scripts/
│   └── sync_buckets.ts         # Fetches bucket schemas from the Wiki and regenerates definitions.ts
├── docs/
│   └── index.html              # GitHub Pages documentation site
├── .github/
│   └── workflows/
│       ├── ci.yml              # Linting, formatting, and testing on PRs
│       ├── docs.yml            # Deploys docs/ to GitHub Pages
│       ├── publish.yml         # NPM publish workflow
│       └── update-buckets.yml  # Nightly bucket definition sync
├── package.json
├── tsconfig.json
└── eslint.config.js
```

### Key Files

- **`src/query-builder.ts`** — Contains the `BucketQueryBuilder` class with all fluent methods (`.select()`, `.where()`, `.join()`, etc.) and the `bucket()` factory function. This is where most feature work happens.
- **`src/types.ts`** — Defines shared types (`Operator`, `ScalarValue`, `BucketCondition`), the `Bucket` helper object (`Bucket.And`, `Bucket.Or`, `Bucket.Not`, `Bucket.Null`), and the `BucketResponse` wrapper class.
- **`src/generated/definitions.ts`** — **Do not edit manually.** This file is auto-generated by `scripts/sync_buckets.ts`. It contains TypeScript interfaces for every bucket and a runtime `BUCKET_FIELDS` map used for wildcard expansion.
- **`scripts/sync_buckets.ts`** — Fetches all bucket schemas from the OSRS Wiki API and writes `definitions.ts`. Run it with `npm run buckets`.

## Getting Started

### Prerequisites
- Node.js 20 or 22
- npm

### Setup
```bash
git clone https://github.com/Dava96/osrs-wiki-bucket-builder.git
cd osrs-wiki-bucket-builder
npm install
```

### Running Tests
```bash
npm test
```

Tests are located in `src/tests/` and use Jest with ESM support. The test runner uses `--experimental-vm-modules` for ES module compatibility.

### Linting & Formatting
```bash
npm run lint          # Checks for ESLint errors
npm run format        # Auto-fixes formatting with Prettier
npm run format:check  # Checks formatting without modifying (used in CI)
```

### Syncing Bucket Definitions
To regenerate the TypeScript definitions from the Wiki:
```bash
npm run buckets
```

This fetches every bucket schema from `Special:AllPages` (namespace 9592) and writes `src/generated/definitions.ts`.

## How to Add a New Method

1. **Add the method** to `BucketQueryBuilder` in `src/query-builder.ts`.
2. **Add any new types** to `src/types.ts` if needed.
3. **Write tests** in `src/tests/query-builder.test.ts`. Aim for at least 80% coverage of new code. Use data providers where applicable.
4. **Update the README** with an example in the appropriate Guide section.
5. **Update the docs site** (`docs/index.html`) with a matching example.
6. **Run checks** before committing:
   ```bash
   npm run lint
   npm run format:check
   npm test
   ```

## Generating Lua Output

The builder's `.printSQL()` method returns the raw Lua string. When developing, it's useful to compare your output against the [Wiki's query syntax](https://meta.weirdgloop.org/w/Extension:Bucket/Usage).

Example of what the builder generates:

```
bucket('exchange').select('name', 'value').where({ 'name', 'Abyssal whip' }).run()
```

You can test queries directly by visiting:
```
https://oldschool.runescape.wiki/api.php?action=bucket&query=<your lua string>
```

## Pull Request Process

1. Create a branch from `main` (e.g. `feature/add-where-like`).
2. Make your changes and ensure all checks pass locally.
3. Push your branch and open a Pull Request.
4. CI will run automatically:
   - **Lint** — ESLint checks on all `src/**/*.ts` files
   - **Format** — Prettier check to enforce consistent style
   - **Test** — Full test suite with coverage reporting
5. PRs require all CI checks to pass before merging.

## Code Style

- TypeScript with strict mode enabled.
- ESLint with `typescript-eslint` for linting.
- Prettier for formatting.
- Methods and variables should read like English — prefer descriptive names over abbreviations.
- No TODOs or shallow implementations — if a feature isn't ready, don't commit it.

## Questions?

Open an issue on the [GitHub repository](https://github.com/Dava96/osrs-wiki-bucket-builder/issues).
